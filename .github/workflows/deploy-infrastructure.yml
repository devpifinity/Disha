name: Deploy Infrastructure

on:
  push:
    branches: [develop, main]
    paths:
      - 'infrastructure/cdk/**'
      - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'CDK action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - diff
          - destroy
      branch:
        description: 'Branch to deploy from'
        required: false
        default: 'main'
        type: string

concurrency:
  group: deploy-infrastructure-${{ github.ref_name }}-${{ inputs.environment || (github.ref_name == 'main' && 'prod' || 'dev') }}
  cancel-in-progress: true

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should-deploy: ${{ steps.env.outputs.should-deploy }}
    steps:
      - name: Determine environment and deployment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy-infrastructure:
    name: Deploy Infrastructure to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.environment == 'prod' && 'production' || 'development' }}
    
    permissions:
      id-token: write
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::418295724706:role/GitHub-OIDC
          role-session-name: GitHubActions-CDK-${{ needs.determine-environment.outputs.environment }}
          aws-region: us-east-1

      - name: Install CDK dependencies
        working-directory: infrastructure/cdk
        run: npm install

      - name: Build CDK
        working-directory: infrastructure/cdk
        run: npm run build

      - name: CDK Bootstrap (if needed)
        working-directory: infrastructure/cdk
        run: |
          # Check if bootstrap is needed
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit 2>/dev/null; then
            echo "Bootstrapping CDK..."
            npx cdk bootstrap -c environment=${{ needs.determine-environment.outputs.environment }}
          else
            echo "CDK already bootstrapped"
          fi

      - name: CDK Diff
        working-directory: infrastructure/cdk
        run: |
          echo "## Infrastructure Changes for ${{ needs.determine-environment.outputs.environment }} environment" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npx cdk diff -c environment=${{ needs.determine-environment.outputs.environment }} >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: CDK Deploy
        if: inputs.action != 'diff' && inputs.action != 'destroy'
        working-directory: infrastructure/cdk
        run: |
          npx cdk deploy --require-approval never -c environment=${{ needs.determine-environment.outputs.environment }}

      - name: CDK Destroy
        if: inputs.action == 'destroy'
        working-directory: infrastructure/cdk
        run: |
          npx cdk destroy --force -c environment=${{ needs.determine-environment.outputs.environment }}

      - name: Extract Stack Outputs
        if: inputs.action != 'destroy'
        working-directory: infrastructure/cdk
        run: |
          # Extract stack outputs and set as environment variables
          STACK_NAME="disha-career-platform-${{ needs.determine-environment.outputs.environment }}"
          ENV="${{ needs.determine-environment.outputs.environment }}"
          
          # Get stack outputs in JSON format
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs' \
            --output json)
          
          # Extract individual values
          S3_BUCKET=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="S3BucketName") | .OutputValue')
          CLOUDFRONT_ID=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="CloudFrontDistributionId") | .OutputValue')
          WEBSITE_URL=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="WebsiteUrl") | .OutputValue')
          
          # Set environment variables for next step
          echo "S3_BUCKET_NAME=$S3_BUCKET" >> $GITHUB_ENV
          echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_ID" >> $GITHUB_ENV
          echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_ENV
          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV

      - name: Validate Stack Outputs
        if: inputs.action != 'destroy'
        run: |
          echo "ðŸ” Validating stack outputs are properly configured..."
          
          STACK_NAME="disha-career-platform-$ENVIRONMENT"
          
          # Validate that all required outputs exist
          echo "ðŸ“‹ Checking stack outputs for: $STACK_NAME"
          
          S3_BUCKET_CHECK=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`S3BucketName`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          CLOUDFRONT_ID_CHECK=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          WEBSITE_URL_CHECK=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`WebsiteUrl`].OutputValue' \
            --output text 2>/dev/null || echo "")
          
          # Validate outputs
          if [ -n "$S3_BUCKET_CHECK" ]; then
            echo "âœ… S3BucketName output: $S3_BUCKET_CHECK"
          else
            echo "âŒ S3BucketName output missing or empty"
            exit 1
          fi
          
          if [ -n "$CLOUDFRONT_ID_CHECK" ]; then
            echo "âœ… CloudFrontDistributionId output: $CLOUDFRONT_ID_CHECK"
          else
            echo "âŒ CloudFrontDistributionId output missing or empty"
            exit 1
          fi
          
          if [ -n "$WEBSITE_URL_CHECK" ]; then
            echo "âœ… WebsiteUrl output: $WEBSITE_URL_CHECK"
          else
            echo "âŒ WebsiteUrl output missing or empty"
            exit 1
          fi
          
          echo ""
          echo "ðŸŽ‰ All stack outputs are properly configured!"
          echo "âœ… Deployment workflows can now query these outputs directly"

      - name: Output Stack Information
        if: inputs.action != 'destroy'
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack Name**: disha-career-platform-${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: us-east-1" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Stack Outputs Configured" >> $GITHUB_STEP_SUMMARY
          echo "Deployment workflows will query these outputs directly from CloudFormation:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output Key | Value | Usage |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`S3BucketName\` | \`$S3_BUCKET_NAME\` | S3 deployment target |" >> $GITHUB_STEP_SUMMARY
          echo "| \`CloudFrontDistributionId\` | \`$CLOUDFRONT_DISTRIBUTION_ID\` | Cache invalidation |" >> $GITHUB_STEP_SUMMARY
          echo "| \`WebsiteUrl\` | \`$WEBSITE_URL\` | Deployed website URL |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ready for Deployment" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment workflows can now be executed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No manual configuration required" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Stack outputs will be queried automatically" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ’¡ **How it works**: Deployment workflows will use \`aws cloudformation describe-stacks\` to get current values directly from the infrastructure stack."